---
  - name: Setup Bastion Host
    hosts: localhost
    connection: local
    gather_facts: false
   
    tasks:
      - name: import bastion setup variables
        include_vars:
          file: vars/bastion_setup.txt
      
      - name: import vpc output variables
        include_vars:
          file: vars/output_vars.txt
      
      - name: import vpc output variables
        include_vars:
          file: vars/vpc_setup.txt

      - name: keypair for bastion hosts
        ec2_key:
          name: "bastion_key"
          region: "{{ region }}"
          # state: present
        register: keypair_out
  
      - name: store keypair
        debug:
          var:  keypair_out

      - name: save private key file
        copy:
          content: "{{ keypair_out.key.name }}.pem"
          dest: "./bastion-key"
          mode: 0400

      - name: Create Security Group
        ec2_group:
          name: "bastion_sg"
          description: "Security"
          region: "{{ region }}"
          vpc_id: "{{ vpc_id }}"
          rules:
            - proto: tcp
              from_port: 22
              to_port: 22
              cidr_ip: "{{MYIP}}"
        register: bastion_sg_out

      - debug:
          var: bastion_sg_out.group_id

      - name: Create Bastion Host instance
        ec2:
          key_name: "bastion_key"
          instance_type: "t2.micro"
          image: "{{ bastion_ami }}"
          wait: true
          region: "{{ region }}"
          group_id: "{{ bastion_sg_out.group_id }}"
          wait_timeout: 300
          wait: yes
          instance_tags:
            Name: "bastion-host"
            Owner: "vprofile"
          exact_count: 1
          count_tag:
            Name: "bastion-host"
            Project: "vprofile"
            Owner: "vprofile"
            group_id: "{{ bastion_sg_out.group_id }}"
            vpc_subnet_id: "{{ pubsub1_id }}"
        register: bastion_istance_out
      
      - name: Print Bastion Host ID
        debug:
          var: bastion_istance_out.instances[0].id
          
